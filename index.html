<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Detection with OpenCV.js</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
        #video { display: none; }
        button { margin: 10px; }
    </style>
</head>
<body>
    <h2>Object Detection with Camera</h2>
    <button id="startCamera">Start Camera</button>
    <button id="stopCamera">Stop Camera</button>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCVReady();" type="text/javascript"></script>
    <script>
        let canvas, ctx, video, streaming = false;
        let videoStream;

        function onOpenCVReady() {
            cv.onRuntimeInitialized = () => {
                document.getElementById('startCamera').addEventListener('click', startCamera);
                document.getElementById('stopCamera').addEventListener('click', stopCamera);
                canvas = document.getElementById('canvas');
                ctx = canvas.getContext('2d');
                video = document.getElementById('video');
            };
        }

        function startCamera() {
            if (streaming) return; // Prevent starting multiple streams
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    videoStream = stream;
                    video.play();
                    video.addEventListener('play', () => {
                        detectObjects();
                    });
                    streaming = true;
                })
                .catch(err => {
                    console.error('Error accessing the camera', err);
                });
        }

        function stopCamera() {
            if (!streaming) return;
            let tracks = videoStream.getTracks();
            tracks.forEach(track => track.stop());
            video.srcObject = null;
            streaming = false;
        }

        function detectObjects() {
            if (!streaming) return;

            let src = cv.imread(video);
            let gray = new cv.Mat();
            let thresh = new cv.Mat();
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();

            // Convert the image to grayscale
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

            // Apply threshold to separate objects from background
            cv.threshold(gray, thresh, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

            // Find contours
            cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Loop through contours
            for (let i = 0; i < contours.size(); i++) {
                let cnt = contours.get(i);
                let area = cv.contourArea(cnt);

                // Draw bounding box
                let rect = cv.boundingRect(cnt);
                let pt1 = new cv.Point(rect.x, rect.y);
                let pt2 = new cv.Point(rect.x + rect.width, rect.y + rect.height);
                let color = new cv.Scalar(0, 255, 0, 255); // Green color
                let thickness = 2;
                cv.rectangle(src, pt1, pt2, color, thickness);

                // Draw area text
                let text = Math.round(area).toString();
                let org = new cv.Point(rect.x, rect.y - 10);
                let fontScale = 1;
                let colorText = new cv.Scalar(0, 0, 255, 255); // Red color
                cv.putText(src, text, org, cv.FONT_HERSHEY_SIMPLEX, fontScale, colorText, thickness, cv.LINE_AA);
            }

            // Show the result
            cv.imshow(canvas, src);

            // Cleanup
            src.delete(); gray.delete(); thresh.delete(); contours.delete(); hierarchy.delete();

            // Call detectObjects recursively
            requestAnimationFrame(detectObjects);
        }
    </script>
</body>
</html>
