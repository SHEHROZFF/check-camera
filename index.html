<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Detection with OpenCV.js</title>
    <style>
        body { margin: 0; }
        #video, #canvas { display: block; }
        #video { width: 100%; height: auto; }
        #canvas { position: absolute; top: 0; left: 0; }
        button { margin: 10px; }
    </style>
</head>
<body>
    <h2>Object Detection with Camera</h2>
    <button id="startCamera">Start Camera</button>
    <button id="stopCamera">Stop Camera</button>
    <button id="switchCamera">Switch Camera</button>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCVReady();" type="text/javascript"></script>
    <script>
        let canvas, ctx, video, streaming = false;
        let videoStream;
        let currentCamera = 0; // 0 for back camera, 1 for front camera

        function onOpenCVReady() {
            cv.onRuntimeInitialized = () => {
                console.log('OpenCV.js is ready');
                document.getElementById('startCamera').addEventListener('click', startCamera);
                document.getElementById('stopCamera').addEventListener('click', stopCamera);
                document.getElementById('switchCamera').addEventListener('click', switchCamera);
                canvas = document.getElementById('canvas');
                ctx = canvas.getContext('2d');
                video = document.getElementById('video');
                window.addEventListener('resize', resizeCanvas);
                resizeCanvas();
            };
        }

        function startCamera() {
            if (streaming) return; // Prevent starting multiple streams
            navigator.mediaDevices.getUserMedia({ video: { facingMode: currentCamera === 0 ? 'environment' : 'user' } })
                .then(stream => {
                    video.srcObject = stream;
                    videoStream = stream;
                    video.play();
                    video.addEventListener('play', () => {
                        resizeCanvas();
                        console.log('Video playing');
                        detectObjects();
                    });
                    streaming = true;
                })
                .catch(err => {
                    console.error('Error accessing the camera', err);
                });
        }

        function stopCamera() {
            if (!streaming) return;
            let tracks = videoStream.getTracks();
            tracks.forEach(track => track.stop());
            video.srcObject = null;
            streaming = false;
        }

        function switchCamera() {
            currentCamera = (currentCamera === 0) ? 1 : 0;
            if (streaming) {
                stopCamera();
                startCamera();
            }
        }

        function resizeCanvas() {
            canvas.width = video.clientWidth;
            canvas.height = video.clientHeight;
        }

        function detectObjects() {
            if (!streaming) return;

            let src = cv.imread(video);
            if (src.empty()) {
                console.error('Error: Video frame is empty.');
                return;
            }

            console.log('Processing frame...');

            let gray = new cv.Mat();
            let thresh = new cv.Mat();
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();

            // Convert the image to grayscale
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

            // Apply threshold to separate objects from background
            cv.threshold(gray, thresh, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

            // Find contours
            cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Check number of contours found
            console.log('Number of contours found:', contours.size());

            // Loop through contours
            for (let i = 0; i < contours.size(); i++) {
                let cnt = contours.get(i);
                let area = cv.contourArea(cnt);
                console.log('Contour area:', area);

                // Draw bounding box
                let rect = cv.boundingRect(cnt);
                let pt1 = new cv.Point(rect.x, rect.y);
                let pt2 = new cv.Point(rect.x + rect.width, rect.y + rect.height);
                let color = new cv.Scalar(0, 255, 0, 255); // Green color
                let thickness = 2;
                cv.rectangle(src, pt1, pt2, color, thickness);

                // Draw area text
                let text = Math.round(area).toString();
                let org = new cv.Point(rect.x, rect.y - 10);
                let fontScale = 1;
                let colorText = new cv.Scalar(0, 0, 255, 255); // Red color
                cv.putText(src, text, org, cv.FONT_HERSHEY_SIMPLEX, fontScale, colorText, thickness, cv.LINE_AA);
            }

            // Show the result
            cv.imshow(canvas, src);

            // Cleanup
            src.delete(); gray.delete(); thresh.delete(); contours.delete(); hierarchy.delete();

            // Call detectObjects recursively
            requestAnimationFrame(detectObjects);
        }
    </script>
</body>
</html>
