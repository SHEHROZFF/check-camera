<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Detection with OpenCV.js</title>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        h2 {
            margin: 20px;
        }
        #canvas {
            border: 1px solid #ccc;
        }
        input[type="file"] {
            margin: 10px;
            padding: 5px;
            font-size: 16px;
        }
        @media (max-width: 600px) {
            #canvas {
                width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <h2>Upload Image for Object Detection</h2>
    <input type="file" id="imageInput" accept="image/*">
    <canvas id="canvas"></canvas>

    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCVReady();" type="text/javascript"></script>
    <script>
        let canvas, ctx;

        function onOpenCVReady() {
            cv.onRuntimeInitialized = () => {
                document.getElementById('imageInput').addEventListener('change', handleImageUpload);
                canvas = document.getElementById('canvas');
                ctx = canvas.getContext('2d');
                // Adjust canvas size on window resize
                window.addEventListener('resize', resizeCanvas);
                resizeCanvas();
            };
        }

        function handleImageUpload(event) {
            let file = event.target.files[0];
            if (!file) return;

            let reader = new FileReader();
            reader.onload = function (e) {
                let imgElement = new Image();
                imgElement.onload = function () {
                    canvas.width = imgElement.width;
                    canvas.height = imgElement.height;
                    ctx.drawImage(imgElement, 0, 0, imgElement.width, imgElement.height);
                    processImage();
                };
                imgElement.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth * 0.9; // Adjust width based on screen size
            canvas.height = canvas.width * 0.75; // Maintain aspect ratio
        }

        function processImage() {
            let src = cv.imread(canvas);
            let gray = new cv.Mat();
            let thresh = new cv.Mat();
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();

            // Convert the image to grayscale
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

            // Apply threshold to separate objects from background
            cv.threshold(gray, thresh, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

            // Find contours
            cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            // Loop through contours
            for (let i = 0; i < contours.size(); i++) {
                let cnt = contours.get(i);
                let area = cv.contourArea(cnt);

                // Draw bounding box
                let rect = cv.boundingRect(cnt);
                let pt1 = new cv.Point(rect.x, rect.y);
                let pt2 = new cv.Point(rect.x + rect.width, rect.y + rect.height);
                let color = new cv.Scalar(0, 255, 0, 255); // Green color
                let thickness = 2;
                cv.rectangle(src, pt1, pt2, color, thickness);

                // Draw area text
                let text = Math.round(area).toString();
                let org = new cv.Point(rect.x, rect.y - 10);
                let fontScale = 1;
                let colorText = new cv.Scalar(0, 0, 255, 255); // Red color
                cv.putText(src, text, org, cv.FONT_HERSHEY_SIMPLEX, fontScale, colorText, thickness, cv.LINE_AA);
            }

            // Show the result
            cv.imshow(canvas, src);

            // Cleanup
            src.delete(); gray.delete(); thresh.delete(); contours.delete(); hierarchy.delete();
        }
    </script>
</body>
</html>
